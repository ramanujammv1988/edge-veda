---
phase: 01-cpp-core-llama-integration
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - scripts/build-ios.sh
  - flutter/ios/Frameworks/EdgeVedaCore.xcframework
autonomous: true

must_haves:
  truths:
    - "Static library builds for iOS device (arm64)"
    - "Static library builds for iOS simulator (arm64)"
    - "XCFramework contains both device and simulator slices"
    - "Binary size is under 15MB per architecture"
  artifacts:
    - path: "scripts/build-ios.sh"
      provides: "iOS build automation script"
      min_lines: 50
    - path: "flutter/ios/Frameworks/EdgeVedaCore.xcframework/Info.plist"
      provides: "XCFramework manifest"
  key_links:
    - from: "scripts/build-ios.sh"
      to: "core/CMakeLists.txt"
      via: "cmake invocation"
      pattern: "cmake.*-DCMAKE_TOOLCHAIN_FILE"
---

<objective>
Build iOS static libraries for device and simulator, then package them into an XCFramework.

Purpose: The XCFramework is required for Flutter iOS plugin distribution. It bundles arm64 device and simulator binaries, allowing the Flutter plugin to work on both real devices and simulators.

Output: EdgeVedaCore.xcframework in flutter/ios/Frameworks/ ready for Flutter plugin integration.
</objective>

<execution_context>
@/Users/ram/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ram/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-cpp-core-llama-integration/01-02-SUMMARY.md
@core/CMakeLists.txt
@core/cmake/ios.toolchain.cmake
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create iOS build script</name>
  <files>
    scripts/build-ios.sh
  </files>
  <action>
Create a comprehensive build script that builds for iOS device and simulator, then creates the XCFramework.

Create `scripts/build-ios.sh`:
```bash
#!/bin/bash
set -e

# Build iOS XCFramework for Edge Veda SDK
# Usage: ./scripts/build-ios.sh [--clean] [--release]

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"
CORE_DIR="$PROJECT_ROOT/core"
OUTPUT_DIR="$PROJECT_ROOT/flutter/ios/Frameworks"
BUILD_DIR="$PROJECT_ROOT/build"

# Parse arguments
CLEAN=false
BUILD_TYPE="Release"

while [[ $# -gt 0 ]]; do
    case $1 in
        --clean)
            CLEAN=true
            shift
            ;;
        --debug)
            BUILD_TYPE="Debug"
            shift
            ;;
        --release)
            BUILD_TYPE="Release"
            shift
            ;;
        *)
            echo "Unknown option: $1"
            exit 1
            ;;
    esac
done

echo "=== Edge Veda iOS Build ==="
echo "Build type: $BUILD_TYPE"
echo "Project root: $PROJECT_ROOT"

# Clean if requested
if [ "$CLEAN" = true ]; then
    echo "Cleaning previous builds..."
    rm -rf "$BUILD_DIR"
    rm -rf "$OUTPUT_DIR/EdgeVedaCore.xcframework"
fi

# Ensure output directory exists
mkdir -p "$OUTPUT_DIR"

# Initialize submodules if needed
if [ ! -f "$CORE_DIR/third_party/llama.cpp/CMakeLists.txt" ]; then
    echo "Initializing git submodules..."
    cd "$PROJECT_ROOT"
    git submodule update --init --recursive
fi

# Build for iOS Device (arm64)
echo ""
echo "=== Building for iOS Device (arm64) ==="
BUILD_IOS_DEVICE="$BUILD_DIR/ios-device"
mkdir -p "$BUILD_IOS_DEVICE"

cmake -B "$BUILD_IOS_DEVICE" \
    -S "$CORE_DIR" \
    -G Xcode \
    -DCMAKE_TOOLCHAIN_FILE="$CORE_DIR/cmake/ios.toolchain.cmake" \
    -DPLATFORM=OS64 \
    -DDEPLOYMENT_TARGET=13.0 \
    -DCMAKE_BUILD_TYPE=$BUILD_TYPE \
    -DEDGE_VEDA_BUILD_SHARED=OFF \
    -DEDGE_VEDA_BUILD_STATIC=ON \
    -DEDGE_VEDA_ENABLE_METAL=ON

cmake --build "$BUILD_IOS_DEVICE" --config $BUILD_TYPE -- -quiet

# Find the built static library
DEVICE_LIB=$(find "$BUILD_IOS_DEVICE" -name "libedge_veda.a" -path "*$BUILD_TYPE*" | head -1)
if [ -z "$DEVICE_LIB" ]; then
    DEVICE_LIB="$BUILD_IOS_DEVICE/$BUILD_TYPE/libedge_veda.a"
fi

if [ ! -f "$DEVICE_LIB" ]; then
    echo "ERROR: Device library not found at $DEVICE_LIB"
    find "$BUILD_IOS_DEVICE" -name "*.a" -ls
    exit 1
fi

echo "Device library: $DEVICE_LIB"
echo "Device library size: $(du -h "$DEVICE_LIB" | cut -f1)"

# Build for iOS Simulator (arm64 for Apple Silicon Macs)
echo ""
echo "=== Building for iOS Simulator (arm64) ==="
BUILD_IOS_SIM="$BUILD_DIR/ios-simulator"
mkdir -p "$BUILD_IOS_SIM"

cmake -B "$BUILD_IOS_SIM" \
    -S "$CORE_DIR" \
    -G Xcode \
    -DCMAKE_TOOLCHAIN_FILE="$CORE_DIR/cmake/ios.toolchain.cmake" \
    -DPLATFORM=SIMULATORARM64 \
    -DDEPLOYMENT_TARGET=13.0 \
    -DCMAKE_BUILD_TYPE=$BUILD_TYPE \
    -DEDGE_VEDA_BUILD_SHARED=OFF \
    -DEDGE_VEDA_BUILD_STATIC=ON \
    -DEDGE_VEDA_ENABLE_METAL=OFF

cmake --build "$BUILD_IOS_SIM" --config $BUILD_TYPE -- -quiet

# Find the built static library
SIM_LIB=$(find "$BUILD_IOS_SIM" -name "libedge_veda.a" -path "*$BUILD_TYPE*" | head -1)
if [ -z "$SIM_LIB" ]; then
    SIM_LIB="$BUILD_IOS_SIM/$BUILD_TYPE/libedge_veda.a"
fi

if [ ! -f "$SIM_LIB" ]; then
    echo "ERROR: Simulator library not found at $SIM_LIB"
    find "$BUILD_IOS_SIM" -name "*.a" -ls
    exit 1
fi

echo "Simulator library: $SIM_LIB"
echo "Simulator library size: $(du -h "$SIM_LIB" | cut -f1)"

# Find llama.cpp and ggml static libraries
echo ""
echo "=== Collecting llama.cpp libraries ==="

# Device libs
DEVICE_LLAMA_LIB=$(find "$BUILD_IOS_DEVICE" -name "libllama.a" -path "*$BUILD_TYPE*" | head -1)
DEVICE_GGML_LIB=$(find "$BUILD_IOS_DEVICE" -name "libggml.a" -path "*$BUILD_TYPE*" | head -1)

# Simulator libs
SIM_LLAMA_LIB=$(find "$BUILD_IOS_SIM" -name "libllama.a" -path "*$BUILD_TYPE*" | head -1)
SIM_GGML_LIB=$(find "$BUILD_IOS_SIM" -name "libggml.a" -path "*$BUILD_TYPE*" | head -1)

# Merge libraries into single static library per platform
echo ""
echo "=== Merging static libraries ==="

MERGED_DIR="$BUILD_DIR/merged"
mkdir -p "$MERGED_DIR/device" "$MERGED_DIR/simulator"

# Merge device libraries
libtool -static -o "$MERGED_DIR/device/libedge_veda_full.a" \
    "$DEVICE_LIB" \
    "$DEVICE_LLAMA_LIB" \
    "$DEVICE_GGML_LIB" \
    2>/dev/null || {
    echo "libtool merge failed, using individual libraries"
    cp "$DEVICE_LIB" "$MERGED_DIR/device/libedge_veda_full.a"
}

# Merge simulator libraries
libtool -static -o "$MERGED_DIR/simulator/libedge_veda_full.a" \
    "$SIM_LIB" \
    "$SIM_LLAMA_LIB" \
    "$SIM_GGML_LIB" \
    2>/dev/null || {
    echo "libtool merge failed, using individual libraries"
    cp "$SIM_LIB" "$MERGED_DIR/simulator/libedge_veda_full.a"
}

echo "Merged device library size: $(du -h "$MERGED_DIR/device/libedge_veda_full.a" | cut -f1)"
echo "Merged simulator library size: $(du -h "$MERGED_DIR/simulator/libedge_veda_full.a" | cut -f1)"

# Create XCFramework
echo ""
echo "=== Creating XCFramework ==="

# Remove existing XCFramework
rm -rf "$OUTPUT_DIR/EdgeVedaCore.xcframework"

# Create XCFramework with static libraries
xcodebuild -create-xcframework \
    -library "$MERGED_DIR/device/libedge_veda_full.a" \
    -headers "$CORE_DIR/include" \
    -library "$MERGED_DIR/simulator/libedge_veda_full.a" \
    -headers "$CORE_DIR/include" \
    -output "$OUTPUT_DIR/EdgeVedaCore.xcframework"

# Verify XCFramework
if [ -d "$OUTPUT_DIR/EdgeVedaCore.xcframework" ]; then
    echo ""
    echo "=== Build Complete ==="
    echo "XCFramework created at: $OUTPUT_DIR/EdgeVedaCore.xcframework"
    echo ""
    echo "Contents:"
    ls -la "$OUTPUT_DIR/EdgeVedaCore.xcframework/"
    echo ""

    # Check binary sizes
    echo "Binary sizes:"
    find "$OUTPUT_DIR/EdgeVedaCore.xcframework" -name "*.a" -exec du -h {} \;

    # Verify architectures
    echo ""
    echo "Architecture verification:"
    for lib in $(find "$OUTPUT_DIR/EdgeVedaCore.xcframework" -name "*.a"); do
        echo "  $lib:"
        lipo -info "$lib" 2>/dev/null || echo "    (not a fat binary)"
    done
else
    echo "ERROR: XCFramework creation failed"
    exit 1
fi

echo ""
echo "=== Done ==="
```

Make the script executable:
```bash
chmod +x scripts/build-ios.sh
```

**Why this approach:**
- Uses Xcode generator (-G Xcode) for proper iOS code signing
- Builds device with Metal ON, simulator with Metal OFF (simulator doesn't support Metal fully)
- Merges llama.cpp libraries into single static lib (simplifies linking)
- Creates XCFramework with headers for Flutter integration
  </action>
  <verify>
```bash
# Script exists and is executable
ls -la scripts/build-ios.sh
file scripts/build-ios.sh  # Should show "Bourne-Again shell script"

# Script has key commands
grep -c "cmake" scripts/build-ios.sh  # >= 4
grep -c "xcodebuild -create-xcframework" scripts/build-ios.sh  # >= 1
```
  </verify>
  <done>
- Build script exists at scripts/build-ios.sh
- Script is executable
- Script builds for both device and simulator
- Script creates XCFramework
  </done>
</task>

<task type="auto">
  <name>Task 2: Run iOS build and create XCFramework</name>
  <files>
    flutter/ios/Frameworks/EdgeVedaCore.xcframework
  </files>
  <action>
Execute the build script to create the XCFramework.

```bash
cd /path/to/project
./scripts/build-ios.sh --clean --release
```

**Expected output:**
- Device library built (arm64)
- Simulator library built (arm64)
- Libraries merged
- XCFramework created at flutter/ios/Frameworks/EdgeVedaCore.xcframework

**If build fails, common issues:**

1. **CMake error "llama.cpp not found":**
   - Run: `git submodule update --init --recursive`

2. **Xcode not found:**
   - Ensure Xcode is installed
   - Run: `xcode-select --install`

3. **Code signing errors:**
   - Static libraries don't need signing
   - If errors persist, add `-DCMAKE_XCODE_ATTRIBUTE_CODE_SIGNING_ALLOWED=NO`

4. **Metal framework not found (simulator build):**
   - Expected - Metal is disabled for simulator build

**Note:** This build may take 5-15 minutes depending on machine speed. llama.cpp is a large codebase.
  </action>
  <verify>
```bash
# XCFramework exists
ls -la flutter/ios/Frameworks/EdgeVedaCore.xcframework/

# Contains both device and simulator
ls flutter/ios/Frameworks/EdgeVedaCore.xcframework/ | grep -c "ios"

# Contains Info.plist
cat flutter/ios/Frameworks/EdgeVedaCore.xcframework/Info.plist

# Check library architectures
for lib in $(find flutter/ios/Frameworks/EdgeVedaCore.xcframework -name "*.a"); do
    echo "=== $lib ==="
    lipo -info "$lib"
done
```
  </verify>
  <done>
- XCFramework directory exists
- Contains ios-arm64 directory (device)
- Contains ios-arm64-simulator directory (simulator)
- Info.plist present
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify binary size and commit build artifacts</name>
  <files>
    scripts/build-ios.sh
  </files>
  <action>
Verify the binary size meets the 15MB requirement and commit the build script.

**Check binary sizes:**
```bash
# Get size of merged libraries
du -h flutter/ios/Frameworks/EdgeVedaCore.xcframework/ios-arm64/libedge_veda_full.a
du -h flutter/ios/Frameworks/EdgeVedaCore.xcframework/ios-arm64_x86_64-simulator/libedge_veda_full.a

# Or if different structure:
find flutter/ios/Frameworks/EdgeVedaCore.xcframework -name "*.a" -exec du -h {} \;
```

**Target:** Each library should be under 15MB. Typical sizes:
- Device (arm64 + Metal): 8-12MB
- Simulator (arm64): 6-10MB

**If over 15MB, troubleshooting:**
1. Verify AVX/AVX2/FMA are OFF in CMakeLists.txt
2. Ensure LTO is enabled for Release builds
3. Strip symbols: `strip -S libedge_veda_full.a`

**Commit the build script (NOT the XCFramework - too large for git):**
```bash
# Add build script to git
git add scripts/build-ios.sh

# Add XCFramework to .gitignore (it's a build artifact)
echo "flutter/ios/Frameworks/EdgeVedaCore.xcframework/" >> .gitignore
git add .gitignore

git commit -m "feat(01-03): add iOS build script and XCFramework generation

- Create build-ios.sh for device and simulator builds
- Configure XCFramework with merged static libraries
- Add XCFramework to .gitignore (build artifact)
- Binary size verified under 15MB target"
```

**Note:** The XCFramework is a build artifact, not source code. It should be:
- Built on CI/CD
- Distributed via CocoaPods or Swift Package Manager
- Not committed to git (too large, platform-specific)
  </action>
  <verify>
```bash
# Check binary sizes
SIZE_DEVICE=$(du -k flutter/ios/Frameworks/EdgeVedaCore.xcframework/ios-arm64/*.a 2>/dev/null | cut -f1 || echo "0")
SIZE_SIM=$(du -k flutter/ios/Frameworks/EdgeVedaCore.xcframework/ios-*-simulator/*.a 2>/dev/null | cut -f1 || echo "0")

echo "Device library: ${SIZE_DEVICE}KB"
echo "Simulator library: ${SIZE_SIM}KB"

# Check if under 15MB (15360KB)
if [ "$SIZE_DEVICE" -lt 15360 ]; then
    echo "Device size OK"
else
    echo "WARNING: Device library exceeds 15MB"
fi

# Verify commit
git log -1 --oneline
```
  </verify>
  <done>
- Device library under 15MB
- Simulator library under 15MB
- Build script committed
- XCFramework in .gitignore
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **XCFramework structure correct:**
   ```bash
   ls flutter/ios/Frameworks/EdgeVedaCore.xcframework/
   # Should show: Info.plist, ios-arm64/, ios-arm64_x86_64-simulator/ (or similar)
   ```

2. **Binary sizes under limit:**
   ```bash
   find flutter/ios/Frameworks/EdgeVedaCore.xcframework -name "*.a" -exec du -h {} \;
   # Each should be < 15MB
   ```

3. **Headers included:**
   ```bash
   find flutter/ios/Frameworks/EdgeVedaCore.xcframework -name "edge_veda.h"
   # Should find the header in each slice
   ```

4. **Build script works:**
   ```bash
   ./scripts/build-ios.sh --clean --release
   # Should complete without errors
   ```
</verification>

<success_criteria>
1. XCFramework created at flutter/ios/Frameworks/EdgeVedaCore.xcframework
2. Contains both device (arm64) and simulator (arm64) slices
3. Binary size under 15MB per slice
4. Build script committed and working
</success_criteria>

<output>
After completion, create `.planning/phases/01-cpp-core-llama-integration/01-03-SUMMARY.md`
</output>
