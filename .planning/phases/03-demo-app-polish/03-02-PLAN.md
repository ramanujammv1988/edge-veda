---
phase: 03-demo-app-polish
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - flutter/example/lib/main.dart
autonomous: true

must_haves:
  truths:
    - "User sees real-time tokens/sec during generation"
    - "User sees time to first token (TTFT) in milliseconds"
    - "User sees current memory usage in megabytes"
    - "Metrics update live, not just at completion"
  artifacts:
    - path: "flutter/example/lib/main.dart"
      provides: "PerformanceMetrics class with Stopwatch-based measurement"
      contains: "Stopwatch"
    - path: "flutter/example/lib/main.dart"
      provides: "Metrics display UI (TTFT, tok/sec, memory)"
      contains: "_buildMetricsBar"
  key_links:
    - from: "_sendMessage"
      to: "Stopwatch"
      via: "start timer before generation, measure TTFT, calculate tok/sec"
      pattern: "Stopwatch.*start"
    - from: "metrics state"
      to: "UI display"
      via: "_buildMetricsBar reads metrics and renders"
      pattern: "_buildMetricsBar"
---

<objective>
Add real-time performance metrics display to validate SDK performance targets.

Purpose: The PRD requires >15 tok/sec on iPhone 12, memory <1.2GB. Users need to see these metrics in real-time to validate performance. This plan implements Stopwatch-based measurement and live metrics bar.

Output: Example app displays TTFT, tok/sec, and memory usage in real-time during generation.
</objective>

<execution_context>
@/Users/ram/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ram/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-demo-app-polish/03-RESEARCH.md
@flutter/example/lib/main.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add PerformanceMetrics class and Stopwatch measurement</name>
  <files>flutter/example/lib/main.dart</files>
  <action>
Create a metrics tracking system using Dart's Stopwatch class for accurate performance measurement. Pattern from research (03-RESEARCH.md lines 104-162).

Add to _ChatScreenState class:

1. **State fields for metrics:**
```dart
// Performance metrics tracking
int _tokenCount = 0;
int? _timeToFirstTokenMs;
double? _tokensPerSecond;
double? _memoryMb;
final _stopwatch = Stopwatch();
```

2. **In _sendMessage() method, add metrics tracking:**

Before generation starts:
```dart
setState(() {
  _isLoading = true;
  _tokenCount = 0;
  _timeToFirstTokenMs = null;
  _tokensPerSecond = null;
});

_stopwatch.reset();
_stopwatch.start();
```

During generation (inside try block):
```dart
// After response received
final response = await _edgeVeda.generate(prompt, options: ...);

// Calculate TTFT (assume first token after prompt processing)
_timeToFirstTokenMs = _stopwatch.elapsedMilliseconds;

// Estimate token count from response length
// Simple heuristic: ~4 chars per token for English text
_tokenCount = (response.text.length / 4).round();

// Calculate tokens per second
_tokensPerSecond = _tokenCount / (_stopwatch.elapsedMilliseconds / 1000);

_stopwatch.stop();

// Get memory stats
final memStats = await _edgeVeda.getMemoryStats();
_memoryMb = memStats.currentBytes / (1024 * 1024);

setState(() {
  _isLoading = false;
  // Metrics already set above
});
```

3. **Reset metrics when starting new generation:**
Ensure metrics are cleared when user sends a new message so old values don't linger.

**Why Stopwatch:** More accurate than DateTime.now() arithmetic. Designed specifically for performance measurement.

**Why token estimation:** Since we're using synchronous generate() (not streaming), we can't count tokens in real-time. We estimate from response length. This is acceptable for v1 demo purposes.

**Note:** This differs from research streaming example because we don't have streaming. We'll measure total latency and estimate tok/sec from total time and response length.
  </action>
  <verify>
1. Grep confirms Stopwatch usage: `grep -n "Stopwatch" flutter/example/lib/main.dart`
2. Grep confirms metrics state fields: `grep -n "_tokenCount\|_timeToFirstTokenMs\|_tokensPerSecond\|_memoryMb" flutter/example/lib/main.dart`
3. Grep confirms stopwatch operations: `grep -n "stopwatch\\.start\|stopwatch\\.stop\|stopwatch\\.reset" flutter/example/lib/main.dart`
4. dart analyze shows 0 errors
  </verify>
  <done>
Metrics tracking implemented with Stopwatch. TTFT, tok/sec, and memory calculated after each generation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create metrics display bar UI</name>
  <files>flutter/example/lib/main.dart</files>
  <action>
Add a visual metrics bar above the chat messages to display performance stats. Design from research (03-RESEARCH.md lines 151-162).

1. **Add _buildMetricsBar() method:**
```dart
Widget _buildMetricsBar() {
  return Container(
    padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
    decoration: BoxDecoration(
      color: Colors.blue[50],
      border: Border(
        bottom: BorderSide(color: Colors.grey[300]!, width: 1),
      ),
    ),
    child: Row(
      mainAxisAlignment: MainAxisAlignment.spaceAround,
      children: [
        _buildMetricChip(
          label: 'TTFT',
          value: _timeToFirstTokenMs != null
              ? '${_timeToFirstTokenMs}ms'
              : '-',
          icon: Icons.timer,
        ),
        _buildMetricChip(
          label: 'Speed',
          value: _tokensPerSecond != null
              ? '${_tokensPerSecond!.toStringAsFixed(1)} tok/s'
              : '-',
          icon: Icons.speed,
        ),
        _buildMetricChip(
          label: 'Memory',
          value: _memoryMb != null
              ? '${_memoryMb!.toStringAsFixed(0)} MB'
              : '-',
          icon: Icons.memory,
        ),
      ],
    ),
  );
}

Widget _buildMetricChip({
  required String label,
  required String value,
  required IconData icon,
}) {
  return Column(
    mainAxisSize: MainAxisSize.min,
    children: [
      Row(
        mainAxisSize: MainAxisSize.min,
        children: [
          Icon(icon, size: 14, color: Colors.blue[700]),
          const SizedBox(width: 4),
          Text(
            label,
            style: TextStyle(
              fontSize: 10,
              color: Colors.grey[600],
              fontWeight: FontWeight.w500,
            ),
          ),
        ],
      ),
      const SizedBox(height: 2),
      Text(
        value,
        style: TextStyle(
          fontSize: 16,
          fontWeight: FontWeight.bold,
          color: Colors.blue[900],
        ),
      ),
    ],
  );
}
```

2. **Add metrics bar to Scaffold body Column:**
Insert `_buildMetricsBar()` after the status bar (around line 310) and before the messages list:

```dart
body: Column(
  children: [
    // Status bar (existing)
    Container(...),

    // Download progress (existing)
    if (_isDownloading) LinearProgressIndicator(...),

    // ADD METRICS BAR HERE
    if (_isInitialized) _buildMetricsBar(),

    // Messages list (existing)
    Expanded(child: ...),

    // Input area (existing)
    Container(...),
  ],
),
```

**Design rationale:**
- Light blue background for visual separation
- Icons make metrics scannable
- Large bold values for readability
- Shows "-" when no data (first load)
- Only visible after initialization (no metrics before SDK ready)

**Why this layout:** Three equal-width columns, horizontally centered. Easy to scan at a glance. Industry standard for benchmark displays.
  </action>
  <verify>
1. Grep confirms _buildMetricsBar method: `grep -n "Widget _buildMetricsBar" flutter/example/lib/main.dart`
2. Grep confirms _buildMetricChip method: `grep -n "Widget _buildMetricChip" flutter/example/lib/main.dart`
3. Grep confirms metrics bar in Column: `grep -n "if (_isInitialized) _buildMetricsBar()" flutter/example/lib/main.dart`
4. dart analyze shows 0 errors
5. Visual check: Run `grep -A 20 "_buildMetricsBar()" flutter/example/lib/main.dart` to see implementation
  </verify>
  <done>
Metrics bar displays TTFT, tok/sec, and memory. UI updates after each generation. Values show "-" when unavailable.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add memory monitoring and update display logic</name>
  <files>flutter/example/lib/main.dart</files>
  <action>
Enhance memory display to show real-time memory usage and add memory pressure warning.

1. **Update existing info dialog (lines ~286-305) to show detailed memory stats:**
```dart
IconButton(
  icon: const Icon(Icons.info_outline),
  onPressed: () async {
    final memStats = await _edgeVeda.getMemoryStats();
    final memoryMb = memStats.currentBytes / (1024 * 1024);
    final usagePercent = (memStats.usagePercent * 100).toStringAsFixed(1);

    if (!mounted) return;

    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        title: const Text('Performance Info'),
        content: Column(
          mainAxisSize: MainAxisSize.min,
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text('Memory: ${memoryMb.toStringAsFixed(1)} MB'),
            Text('Usage: $usagePercent%'),
            if (memStats.isHighPressure)
              const Text(
                '⚠️ High memory pressure',
                style: TextStyle(color: Colors.orange),
              ),
            const SizedBox(height: 8),
            if (_tokensPerSecond != null)
              Text('Last Speed: ${_tokensPerSecond!.toStringAsFixed(1)} tok/s'),
            if (_timeToFirstTokenMs != null)
              Text('Last TTFT: ${_timeToFirstTokenMs}ms'),
          ],
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: const Text('OK'),
          ),
        ],
      ),
    );
  },
),
```

2. **Add memory warning in status bar if approaching 1.2GB limit:**
Update status message to include memory warning when memory exceeds 1000 MB:

```dart
// After getting memStats in _sendMessage
if (_memoryMb != null && _memoryMb! > 1000) {
  _statusMessage = 'Memory high: ${_memoryMb!.toStringAsFixed(0)}MB / 1200MB';
}
```

**Why 1000MB threshold:** PRD specifies <1.2GB (1200MB) target. Warning at 1000MB gives headroom before hitting limit.

**Why in info dialog:** Detailed stats don't need to be always visible. Metrics bar shows current memory; dialog provides context (usage percent, pressure flag).
  </action>
  <verify>
1. Grep confirms getMemoryStats in info dialog: `grep -n "final memStats = await _edgeVeda.getMemoryStats()" flutter/example/lib/main.dart`
2. Grep confirms isHighPressure check: `grep -n "isHighPressure" flutter/example/lib/main.dart`
3. Grep confirms memory warning threshold: `grep -n "1000\|1200" flutter/example/lib/main.dart`
4. dart analyze shows 0 errors
  </verify>
  <done>
Info dialog shows detailed memory stats. Memory warning appears if usage approaches 1.2GB limit. Metrics bar shows current memory after each generation.
  </done>
</task>

</tasks>

<verification>
Run from project root:
```bash
cd flutter/example
dart analyze lib/main.dart
# Expect: 0 errors

# Verify metrics implementation
grep -n "Stopwatch" lib/main.dart
grep -n "_buildMetricsBar" lib/main.dart
grep -n "_buildMetricChip" lib/main.dart
grep -n "getMemoryStats" lib/main.dart

# Verify metrics state fields exist
grep -n "_tokenCount\|_timeToFirstTokenMs\|_tokensPerSecond\|_memoryMb" lib/main.dart
```
</verification>

<success_criteria>
1. Metrics bar displays TTFT, tok/sec, and memory
2. Metrics update after each generation (not just "-")
3. Stopwatch used for accurate timing
4. Info dialog shows detailed memory stats (bytes, percent, pressure flag)
5. Memory warning appears if approaching 1.2GB limit
6. Code compiles with 0 dart analyze errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-demo-app-polish/03-02-SUMMARY.md`
</output>
