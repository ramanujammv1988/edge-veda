---
phase: 04-release
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - .github/workflows/release.yml
autonomous: false

user_setup:
  - service: pub.dev
    why: "Publishing Flutter package to pub.dev registry"
    env_vars:
      - name: PUB_TOKEN
        source: "pub.dev account -> My Account -> Create Token"
    dashboard_config:
      - task: "Generate publishing token"
        location: "https://pub.dev -> Sign in -> Account -> Create Token"
        details: "Token needs 'Publish packages' permission, store as GitHub secret PUB_TOKEN"

must_haves:
  truths:
    - "Release workflow triggers on version tag push (v*)"
    - "XCFramework builds and uploads to GitHub Releases automatically"
    - "Package publishes to pub.dev with valid authentication"
    - "Workflow fails fast if version mismatch detected"
    - "Published package appears on pub.dev within 5 minutes of tag push"
  artifacts:
    - path: ".github/workflows/release.yml"
      provides: "Automated release workflow"
      min_lines: 120
      contains: "on: push: tags:"
  key_links:
    - from: ".github/workflows/release.yml"
      to: "scripts/build-ios.sh"
      via: "workflow step execution"
      pattern: "run:.*build-ios.sh"
    - from: ".github/workflows/release.yml"
      to: "PUB_TOKEN secret"
      via: "environment variable"
      pattern: "secrets.PUB_TOKEN"
---

<objective>
Automate the complete release process with GitHub Actions workflow that builds XCFramework, creates GitHub Release, validates package, and publishes to pub.dev on version tag push.

Purpose: Enable one-command releases (`git tag v1.0.0 && git push --tags`) that automatically handle binary distribution and package publishing. This removes manual steps, ensures consistency, and allows rapid patch releases if needed.

Output: Release workflow that builds iOS XCFramework, uploads to GitHub Releases, runs pana validation, and publishes to pub.dev with proper authentication and error handling.
</objective>

<execution_context>
@/Users/ram/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ram/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/ram/Documents/explore/edge/.planning/PROJECT.md
@/Users/ram/Documents/explore/edge/.planning/ROADMAP.md
@/Users/ram/Documents/explore/edge/.planning/STATE.md
@/Users/ram/Documents/explore/edge/.planning/phases/04-release/04-RESEARCH.md
@/Users/ram/Documents/explore/edge/.planning/phases/04-release/04-01-PLAN.md

# Existing CI workflow for reference
@/Users/ram/Documents/explore/edge/.github/workflows/ci.yml

# Scripts the workflow will call
@/Users/ram/Documents/explore/edge/scripts/build-ios.sh
@/Users/ram/Documents/explore/edge/scripts/prepare-release.sh
</context>

<tasks>

<task type="auto">
  <name>Create GitHub Actions release workflow</name>
  <files>.github/workflows/release.yml</files>
  <action>
Create a GitHub Actions workflow that automates the complete release process.

Structure the workflow with 3 jobs:

**Job 1: validate-release**
- Runs on: ubuntu-latest
- Trigger: on: push: tags: ['v*']
- Steps:
  1. Checkout with submodules: recursive
  2. Setup Flutter 3.24.0 (match CI)
  3. Extract version from tag: `echo "${GITHUB_REF#refs/tags/v}"` -> VERSION env var
  4. Run prepare-release.sh $VERSION to validate versions match
  5. Fail fast if validation fails - don't proceed to expensive build
- Outputs: version (for downstream jobs)

**Job 2: build-and-release-xcframework**
- Runs on: macos-latest
- Needs: validate-release
- Steps:
  1. Checkout with submodules: recursive
  2. Setup Xcode: uses maxim-lobanov/setup-xcode@v1 (match CI)
  3. Install CMake and Ninja: `brew install cmake ninja ccache`
  4. Configure ccache: uses hendrikmuhs/ccache-action@v1.2 with key: ios-release (match CI)
  5. Build XCFramework: `./scripts/build-ios.sh --clean --release`
  6. Verify XCFramework size: fail if >30MB (indicates bloat)
  7. Create ZIP archive: `cd flutter/ios/Frameworks && zip -r EdgeVedaCore-ios.xcframework.zip EdgeVedaCore.xcframework`
  8. Create GitHub Release:
     - Use: softprops/action-gh-release@v1
     - Files: flutter/ios/Frameworks/EdgeVedaCore-ios.xcframework.zip
     - Body: Release notes from CHANGELOG.md [1.0.0] section
     - Draft: false (publish immediately)
     - Prerelease: false
     - Generate_release_notes: true

**Job 3: publish-to-pub-dev**
- Runs on: ubuntu-latest
- Needs: build-and-release-xcframework (ensure binary available first)
- Steps:
  1. Checkout code (no submodules needed)
  2. Setup Flutter 3.24.0
  3. Get Flutter dependencies: `cd flutter && flutter pub get`
  4. Run pana validation: `dart pub global activate pana && dart pub global run pana --no-warning .`
  5. Fail if pana score <120 (pub.dev will reject low scores)
  6. Setup pub.dev credentials:
     - Create ~/.pub-cache/credentials.json from PUB_TOKEN secret
     - Format: `{"accessToken":"${{ secrets.PUB_TOKEN }}","refreshToken":"","tokenEndpoint":"https://pub.dev","scopes":["https://www.googleapis.com/auth/userinfo.email"],"expiration":...}`
  7. Publish to pub.dev: `cd flutter && dart pub publish --force`
  8. Note: --force skips interactive confirmation (required for CI)

Important considerations:
- Use existing CI patterns (same Xcode setup, Flutter version, ccache config)
- Add timeout-minutes: 45 to build job (XCFramework build is expensive)
- Add timeout-minutes: 10 to validate and publish jobs
- Use `if: startsWith(github.ref, 'refs/tags/v')` as additional guard
- Don't use `prepare_command` in podspec - it doesn't run from pub.dev packages
- Include comprehensive error messages for common failures:
  - Missing PUB_TOKEN secret
  - Version mismatch
  - XCFramework build failure
  - pana score too low

Reference the research document's workflow example but adapt to our specific needs (3-job structure, version validation, pana scoring).
  </action>
  <verify>
grep -q "on:" /Users/ram/Documents/explore/edge/.github/workflows/release.yml
grep -q "tags:.*v\*" /Users/ram/Documents/explore/edge/.github/workflows/release.yml
grep -q "build-ios.sh" /Users/ram/Documents/explore/edge/.github/workflows/release.yml
grep -q "dart pub publish" /Users/ram/Documents/explore/edge/.github/workflows/release.yml
grep -q "PUB_TOKEN" /Users/ram/Documents/explore/edge/.github/workflows/release.yml
  </verify>
  <done>release.yml exists with 3 jobs (validate, build-xcframework, publish), triggers on v* tags, builds XCFramework, creates GitHub Release, publishes to pub.dev with PUB_TOKEN authentication</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <action>Configure pub.dev authentication token in GitHub Secrets</action>
  <instructions>
The release workflow requires a pub.dev publishing token stored as a GitHub secret.

**Steps to complete:**

1. **Generate pub.dev token:**
   - Visit: https://pub.dev
   - Sign in with Google account that will own the package
   - Navigate: Account (top right) -> Publishing Access
   - Click "Create Token"
   - Grant "Publish packages" permission
   - Copy the generated token (shows only once)

2. **Add token to GitHub Secrets:**
   - Visit: https://github.com/edgeveda/edge-veda-sdk/settings/secrets/actions
   - Click "New repository secret"
   - Name: `PUB_TOKEN`
   - Value: [paste token from step 1]
   - Click "Add secret"

3. **Verify token added:**
   - Check that PUB_TOKEN appears in the secrets list
   - Value should be masked (••••••)

**Security note:** This token allows publishing packages under your pub.dev account. Store securely and rotate if compromised.

**Verification:** Confirm token added by typing "token-added" below.
  </instructions>
  <resume-signal>Type "token-added" when GitHub secret is configured, or "skip-for-now" to continue without it (publish will fail but other jobs will work)</resume-signal>
</task>

<task type="auto">
  <name>Validate workflow syntax and structure</name>
  <files></files>
  <action>
Validate the release workflow structure and syntax.

Checks to perform:
1. YAML syntax validation: `yamllint .github/workflows/release.yml` (if available) or manual inspection
2. Verify job dependencies: validate-release -> build-and-release-xcframework -> publish-to-pub-dev
3. Verify trigger: on.push.tags matches ['v*'] pattern
4. Check required secrets referenced: PUB_TOKEN
5. Verify outputs defined: version from validate-release job
6. Check uses: actions are at pinned versions (v1, v2, v4 - not @main)

Common issues to catch:
- Indentation errors in YAML
- Missing `needs:` fields for job dependencies
- Incorrect secret reference (should be `${{ secrets.PUB_TOKEN }}`)
- Missing working-directory for flutter commands
- Incorrect path to scripts (should be relative to project root)

If yamllint not available, manually review workflow for proper YAML structure. The workflow should be ~150-200 lines with clear job separation and comprehensive error handling.
  </action>
  <verify>
cd /Users/ram/Documents/explore/edge && cat .github/workflows/release.yml | grep -E "jobs:|needs:|secrets.PUB_TOKEN" | head -20
test -f /Users/ram/Documents/explore/edge/.github/workflows/release.yml && echo "Workflow file exists"
  </verify>
  <done>release.yml has valid YAML syntax, 3 jobs with proper dependencies, triggers on v* tags, references PUB_TOKEN secret correctly</done>
</task>

</tasks>

<verification>
Workflow validation checklist:
1. File exists: `.github/workflows/release.yml`
2. Trigger configured: `on: push: tags: ['v*']`
3. Job 1 (validate-release): Runs prepare-release.sh
4. Job 2 (build-xcframework): Builds iOS binary, uploads to GitHub Releases
5. Job 3 (publish-pub): Publishes to pub.dev with PUB_TOKEN
6. Job dependencies correct: Job 2 needs Job 1, Job 3 needs Job 2
7. PUB_TOKEN secret referenced correctly
8. Scripts referenced exist: build-ios.sh, prepare-release.sh

Manual test (after 04-03 completes):
1. Create test tag: `git tag v1.0.0-rc1`
2. Push tag: `git push origin v1.0.0-rc1`
3. Monitor workflow: https://github.com/edgeveda/edge-veda-sdk/actions
4. Verify: XCFramework uploaded to Releases, package appears on pub.dev
</verification>

<success_criteria>
- [ ] .github/workflows/release.yml exists with 3 jobs
- [ ] Workflow triggers on push to tags matching v*
- [ ] validate-release job runs prepare-release.sh and outputs version
- [ ] build-and-release-xcframework job builds XCFramework and creates GitHub Release
- [ ] publish-to-pub-dev job runs pana validation and publishes with PUB_TOKEN
- [ ] Job dependencies configured: validate -> build -> publish
- [ ] PUB_TOKEN secret added to GitHub repository settings
- [ ] Workflow YAML syntax is valid (manual review)
- [ ] All script paths correct relative to project root
</success_criteria>

<output>
After completion, create `.planning/phases/04-release/04-02-SUMMARY.md` documenting:
- Release workflow structure (3 jobs, dependencies)
- pub.dev token setup status
- Workflow validation results
- Manual testing recommendations for v1.0.0-rc1
- Readiness for 04-03 (Final Validation and Publish)
</output>
